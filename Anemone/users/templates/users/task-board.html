<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>Phourtnight</title>
	
	{% load static %}
	
	<!-- link favicon -->
	<link rel="icon" href="{% static 'users/assets/icons/logo-favicon.png' %}" type="image/png">
	
	<!-- main style -->
	<link rel="stylesheet" href="{% static 'users/styles/main-style.css' %}">
	
	<!-- task board style -->
	<link rel="stylesheet" href="{% static 'users/styles/task-board.css' %}">
	
	<!-- task form style -->
	<link rel="stylesheet" href="{% static 'users/styles/task-form.css' %}">
	
	<!-- claim task form -->
	<link rel="stylesheet" href="{% static 'users/styles/claim-task-form.css' %}">
	
	<!-- task style -->
	<link rel="stylesheet" href="{% static 'users/styles/task.css' %}">
	
	<!-- google icons -->
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
	
	<!-- jquery cdns -->
	<!-- import jquery -->
	<script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
		crossorigin="anonymous"></script>
	
	<!-- import jquery ui -->
	<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"
		integrity="sha256-6XMVI0zB8cRzfZjqKcD01PBsAy3FlDASrlC8SxCpInY=" crossorigin="anonymous"></script>
	
	</head>
	
	<body>
		
		 <!-- mobile nav -->
		 <div class="mobile-nav-container">

			<nav class="mobile-nav">
				<!-- dashboard -->
				<button class="menu-item">
					<a href="{% url 'dashboard' %}" class="nav-link">
						<span class="material-symbols-rounded mobile-current">dashboard</span>
					</a>
				</button>
			
				<!-- tasks -->
				<button class="menu-item mobile-current">
					<a href="{% url 'taskboard' %}" class="nav-link">
						<span class="material-symbols-rounded">task_alt</span>
					</a>
				</button>
			
				<!-- notificatoins -->
				<button class="menu-item">
					<a href="{% url 'bulletin' %}" class="nav-link">
						<span class="material-symbols-rounded">notifications</span>
					</a>
				</button>
			
				<!-- leaderboard -->
				<button class="menu-item">
					<a href="{% url 'leaderboard' %}" class="nav-link">
						<span class="material-symbols-rounded">leaderboard</span>
					</a>
				</button>
			
				<!-- lootbox -->
				<button class="menu-item">
					<a href="{% url 'lootbox' %}" class="nav-link">
						<span class="material-symbols-rounded">redeem</span>
					</a>
				</button>
			
				<!-- settings -->
				<button class="menu-item">
					<a href="{% url 'settings' %}" class="nav-link">
						<span class="material-symbols-rounded">settings</span>
					</a>
				</button>
			
				<!-- game guide -->
				<button class="menu-item">
					<a href="{% url 'guide' %}" class="nav-link">
						<span class="material-symbols-rounded">help</span>
					</a>
				</button>
			
				<!-- login/logout -->
				<button class="menu-item">
					<a href="{% url 'logout' %}" class="nav-link">
						<span class="material-symbols-rounded">logout</span>
					</a>
				</button>
			</nav>
		</div>

		<div class="main-grid">
	
			<!-- create task form -->
			<div id="form-container" class="task-form-container">
	
				<div class="exit-btn-container">
					<button id="exit-btn">
						<span class="material-symbols-rounded">close</span>
					</button>
				</div>
	
				<div class="header-container">
					<h2>Let's Create a Task!</h2>
				</div>
	
				<form action="" method="post" class="task-form">
					{% csrf_token %}
	
					<div class="task-name-container">
						<label for="task_name"></label>
						<input type="text" id="task_name" placeholder="Name" name="task_title" required>
					</div>
	
					<div class="task-detail-container">
						<label for="task_detail"></label>
						<textarea id="task_detail" id="" cols="40" rows="3" placeholder="Details"
							name="task_body"></textarea>
					</div>

					<div class="due-date-container">
	
						<div class="created-container">
							<p>Created:
								<span id="todays-date">today's date here</span>
							</p>
						</div>
	
						<div class="due-container">
							<label for="end_date">Due:</label>
							<input type="date" id="end_date" name="due_date" required>
							<p>
								You have
								<span id="total-days">X</span>
								days till this task is due.
							</p>
						</div>
	
					</div>
	
					<!-- <div class="repeats-container">
	
						<div class="repeat-toggle-container">
	
							<label for="repeat_toggle">Repeats?</label>
							<input type="checkbox" name="repeats" id="repeat_toggle" checked="false">
	
						</div>
	
						<div class="repeat-expanded">
	
							<div class="every-container">
	
								<div class="radio-container">
	
									<div class="radio-btn">
										<input type="radio" name="repeat-type-radio" id="week" value="weekly">
										<label for="repeat_type">Weekly</label>
									</div>
	
									<div class="radio-btn">
										<input type="radio" name="repeat-type-radio" id="month" value="montly">
										<label for="repeat_type">Monthly</label>
									</div>
	
								</div>
	
							</div>
	
							<div class="repeat-on-container">
								<p>Repeat on:</p>
	
								<div class="days-of-the-week-container">
	
									<label for="mon">Monday</label>
									<input type="checkbox" id="mon" name="mo">
	
									<label for="tue">Tuesday</label>
									<input type="checkbox" id="tue" name="tu">
	
									<label for="wed">Wednesday</label>
									<input type="checkbox" id="wed" name="we">
	
									<label for="thu">Thursday</label>
									<input type="checkbox" id="thu" name="th">
	
									<label for="fri">Friday</label>
									<input type="checkbox" id="fri" name="fr">
	
									<label for="sat">Saturday</label>
									<input type="checkbox" id="sat" name="sa">
	
									<label for="sun">Sunday</label>
									<input type="checkbox" id="sun" name="su">
	
								</div>
								</br>
								<label for="day_of_month">Monthly (day of month): </label>
								<input type="number" name="day_of_month" min="1" max="31"><br>
	
							</div>
						</div>
					</div> -->
	
					<div class="submit-task-container">
						<button type="submit" id="submit-btn">
							<p>Create Task</p>
						</button>
					</div>
				</form>
			</div>
	
			<section class="left-section">
				<!-- desktop nav -->
				<nav id="nav-sidebar">

					<div class="logo-container">
						<img id="logo" src="{% static 'users/assets/icons/logo-round.png' %}" alt="logo">
					</div>
	
					<div class="nav-sidebar-content">
	
						<ul class="list">
	
							<!-- dashboard -->
							<li class="list-item">
								<a href="{% url 'dashboard' %}" class="nav-link">
									<span class="material-symbols-rounded mobile-current">dashboard</span>
									<span class="link">Dashboard</span>
								</a>
							</li>
	
							<!-- tasks -->
							<li class="list-item">
								<a href="{% url 'taskboard' %}" class="nav-link desktop-current">
									<span class="material-symbols-rounded">task_alt</span>
									<span class="link">Tasks</span>
								</a>
							</li>
	
							<!-- notifications/bulletin -->
							<li class="list-item">
								<a href="{% url 'bulletin' %}" class="nav-link">
									<span class="material-symbols-rounded">notifications</span>
									<span class="link">Notifications</span>
								</a>
							</li>
	
							<!-- leaderboard -->
							<li class="list-item">
								<a href="{% url 'leaderboard' %}" class="nav-link">
									<span class="material-symbols-rounded">leaderboard</span>
									<span class="link">Leaderboard</span>
								</a>
							</li>
	
							<!-- lootbox -->
							<li class="list-item">
								<a href="{% url 'lootbox' %}" class="nav-link">
									<span class="material-symbols-rounded">redeem</span>
									<span class="link">Lootbox</span>
								</a>
							</li>
	
						</ul>
	
	
						<div class="list-bottom-content">
	
							<!-- settings -->
							<li class="list-item">
								<a href="{% url 'settings' %}" class="nav-link">
									<span class="material-symbols-rounded">settings</span>
									<span class="link">Settings</span>
								</a>
							</li>
	
							<!-- game guide -->
							<li class="list-item">
								<a href="{% url 'guide' %}" class="nav-link">
									<span class="material-symbols-rounded">help</span>
									<span class="link">Game Guide</span>
								</a>
							</li>
	
							<!-- logout -->
							<li class="list-item">
								<a href="{% url 'logout' %}" class="nav-link">
									<span class="material-symbols-rounded">logout</span>
									<span class="link">Logout</span>
								</a>
							</li>
						</div>
					</div>
				</nav>
			</section>
	
			<section class="middle-section">
	
				<div class="top-button-container">
	
					<div class="right-buttons-container">
						<button class="button right" type="button" data-toggle="modal" data-target="#form-container">
							<span class="material-symbols-rounded">add</span>
							<p>Add Task</p>
						</button>
					</div>
	
				</div>
	
				<div class="bottom-container">
	
					<div class="task-column-container">
	
						<!-- unclaimed -- doesn't move -->
						<div class="column" id="unclaimed-column">
	
							<div class="column-header-container">
								<h4 class="column-header">
									Unclaimed
									<span class="column-total">{{ unclaimed_tasks|length }}</span>
								</h4>
							</div>
	
							{% for task in unclaimed_tasks %}
							<div class="a-task unclaimed" id="{{ task.id }}">

								<div class="task-priority-container">
									<div class="task-user-img"></div>
								</div>
								
								<div class="task-description-container">
									<h3 class="task-title">{{ task.title }}</h3>
	
									<p class="task-description">{{ task.body }}</p>

									<p class="task-description bid" , id="bidtext{{ task.id }}">
										Current bid:
										<span id="curr-bid"> {{ task.points }}pts</span>
									</p>
								</div>
	
								<hr class="task-horz-line">
	
								<div class="task-stats">
	
									<div class="bid-container">
										<input type="number" name="" id="bid{{ task.id }}" placeholder="Your Bid">
									</div>
	
				
									<div class="task-bid-ends">
										<p>
											Bid Ends:
											<span id="bid-ends">{{ task.due_date|date:'F d, Y' }}</span>
										</p>
									</div>

									<div class="task-due-date">
										<p>
											Due:
											<span id="due-date">{{ task.due_date|date:'h:i A | F d, Y' }}</span>
										</p>
									</div>

									<!-- hiding submit the button -->
									<button type="submit" id="submit-bid-btn" style="display: none;">Submit</button>
								</div>
							</div>
							{% endfor %}
						</div>
	
						<!-- to do -->
						<div class="column move" id="to-do-column">
	
							<div class="column-header-container">
								<h4 class="column-header">
									To Do <span class="column-total" id="to-do-total">{{ todo_tasks|length }}</span>
								</h4>
							</div>
	
							<!-- a task -->
							{% for task in todo_tasks %}
							<div class="a-task claimed {{ task.user_claimed.pk }}" draggable="true" id="{{ task.id }}">
								<div class="task-description-container">
									<h3 class="task-title">{{ task.title }}</h3>
	
									<p class="task-description">{{ task.body }}</p>
								</div>
	
								<hr class="task-horz-line">
	
								<div class="task-stats">

									<div class="claimed-by">
										<p>Claimed By:</p>

										<div class="task-user-img">
											{% if user.profile.pk == task.user_claimed.pk %}
											<div class="curr-user-container">
												<img src="{% static 'users/assets/icons/logo-current-user.png' %}" alt="">
											</div>
											{% else %}
											<div class="other-user-container">
												<img src="{% static 'users/assets/icons/logo-round.png' %}" alt="">
											</div>
											{% endif %}
											<p id="user-name"> {{ task.user_claimed.first_name }} {{ task.user_claimed.last_name }} </p>
										</div>

									</div>
	
									<div class="task-points">
										<p>
											Points:
											<span id="current-points">{{ task.points }}pts</span>
										</p>

									</div>
				
									
									<div class="task-due-date">
										<p>
											Due:
											<span id="due-date">{{ task.due_date|date:'h:i A | F d, Y' }}</span>
										</p>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
	
						<!-- in progress -->
						<div class="column move" id="in-prog-column">
	
							<div class="column-header-container">
								<h4 class="column-header">
									In Progress <span class="column-total" id="in-prog-total">{{ in_prog_tasks|length }}</span>
								</h4>
							</div>
	
							<!-- a task -->
							{% for task in in_prog_tasks %}
							<div class="a-task claimed {{ task.user_claimed.pk }}" draggable="true" id="{{ task.id }}">
								<div class="task-description-container">
									<h3 class="task-title">{{ task.title }}</h3>
	
									<p class="task-description">{{ task.body }}</p>
								</div>
	
								<hr class="task-horz-line">
	
								<div class="task-stats">

									<div class="claimed-by">
										<p>Claimed By:</p>

										<div class="task-user-img">
											{% if user.profile.pk == task.user_claimed.pk %}
											<img src="{% static 'users/assets/icons/logo-current-user.png' %}" alt="">
											{% else %}
											<img src="{% static 'users/assets/icons/logo-round.png' %}" alt="">
											{% endif %}
											<p id="user-name"> {{ task.user_claimed.first_name }} {{ task.user_claimed.last_name }} </p>
										</div>

									</div>

									<div class="task-points">
										<p>
											Points:
											<span id="current-points">{{ task.points }}pts</span>
										</p>

									</div>
	
									<div class="task-due-date">
										<p>
											Due:
											<span id="due-date">{{ task.due_date|date:'h:i A | F d, Y' }}</span>
										</p>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
	
						<!-- completed -->
						<div class="column move" id="complete-column">
	
							<div class="column-header-container">
								<h4 class="column-header">
									Completed <span class="column-total" id="complete-total">{{ complete_tasks|length }}</span>
								</h4>
							</div>
	
							<!-- a task -->
							{% for task in complete_tasks %}
							<div class="a-task claimed {{ task.user_claimed.pk }}" draggable="true" id="{{ task.id }}">
								<div class="task-description-container">
									<h3 class="task-title">{{ task.title }}</h3>
	
									<p class="task-description">{{ task.body }}</p>
								</div>
	
								<hr class="task-horz-line">
	
								<div class="task-stats">

									<div class="claimed-by">
										<p>Claimed By:</p>

										<div class="task-user-img">
											{% if user.profile.pk == task.user_claimed.pk %}
											<img src="{% static 'users/assets/icons/logo-current-user.png' %}" alt="">
											{% else %}
											<img src="{% static 'users/assets/icons/logo-round.png' %}" alt="">
											{% endif %}
											<p id="user-name"> {{ task.user_claimed.first_name }} {{ task.user_claimed.last_name }} </p>
										</div>

									</div>

									<div class="task-points">
										<p>
											Points:
											<span id="current-points">{{ task.points }}pts</span>
										</p>
									</div>
	
									<div class="task-due-date">
										<p>
											Due:
											<span id="due-date">{{ task.due_date|date:'h:i A | F d, Y' }}</span>
										</p>
									</div>

								</div>
							</div>
							{% endfor %}
						</div>
	
					</div>
	
				</div>
	
			</section>
	
		</div>

	<script type="text/javascript">
		
		$( document ).ready(function() {

			/* =================== GETS CSRF TOKEN =================== */
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						// Does this cookie string begin with the name we want?
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}
			var csrftoken = getCookie('csrftoken');

			/* =================== MOVE TASK CARD =================== */
			// tasks can only move between 'to do', 'in progress', and 'completed'
			$(".column.move").sortable ({
				cursor: 'move',
				connectWith: '.column.move',
				items: ".{{ user.pk }}",
				update: function(event, ui) {
					if (this === ui.item.parent()[0]) {
						var data = new Object();
						data.type = "task_move";
						data.id = ui.item.attr("id");
						data.new_pos = ui.item.parent().attr("id");
						var jsonData = JSON.stringify(data);
						$.ajax({
							type: "POST",
							url: "{% url 'taskboard' %}",
							headers: { 'X-CSRFToken': csrftoken },
							//dataType: "json",
							data: jsonData,
							contentType: "application/json",
							success: function(result) {
			//	$("#bidtext{{ task.id }}").text("Current bid: " + user_bid)
								var toDoCount = $("#to-do-column").children(".a-task").length;
								$("#to-do-total").text(toDoCount)
								var inProgCount = $("#in-prog-column").children(".a-task").length;
								$("#in-prog-total").text(inProgCount)
								var completeCount = $("#complete-column").children(".a-task").length;
								$("#complete-total").text(completeCount)
							},
							error: function(response) {
								alert("Something went wrong in processing your move.");
							}
						});
					}
				},
			});

			/* =================== GET USER BID =================== */
			{% for task in unclaimed_tasks %}
				$("#bid{{ task.id }}").on("keypress", 
					function (e) {
						// on enter
						if (e.which == 13) {
							//Ensure input is valid
							user_bid = parseInt($("#bid{{ task.id }}").val());
							if ( !Number.isInteger(user_bid) ) {
								alert("Your bid must be an integer.")
							} 
							else if ( user_bid >= {{ task.points }} && user_bid) {
								alert("Your bid must be lower than the current bid.");
							} 
							else if ( user_bid < 1 ) {
								alert("Your bid must be greater than 0")
							} 
							else { //Send payload
								var data = new Object();
								data.type = "user_bid";
								data.id = {{ task.id }};
								data.bid = user_bid;
								var jsonData = JSON.stringify(data);
								$.ajax({
									type: "POST",
									url: "{% url 'taskboard' %}",
									headers: { 'X-CSRFToken': csrftoken },
									//dataType: "json",
									data: jsonData,
									contentType: "application/json",
									success: function(result) {
										$("#bidtext{{ task.id }}").text("Current bid: " + user_bid)
									},
									error: function(response) {
										alert("Something went wrong in processing your bid.");
									}
								});
							}
						}
					}
				);
			{% endfor %}

			/* =================== SHOW AND HIDE CREATE TASK FORM =================== */
			// make the Add Task button show the form (= slide in)
			$(".right-buttons-container .button.right").click(
				function (e) {
					e.preventDefault();

					// reset inputs
					$(':input','#form-container')
						.not(':button, :submit, :reset, :hidden')
						.val('')
						.prop('checked', false)
						.prop('selected', false);

					$("#form-container").show({
						duration: '1000'
					});
				}
			);

			// make the x on the form close the form (= slide out)
			$("#exit-btn").click(function (e) { 
				e.preventDefault();

				// reset inputs
				$(':input','#form-container')
					.not(':button, :submit, :reset, :hidden')
					.val('')
					.prop('checked', false)
					.prop('selected', false);
					
				$("#form-container").hide({
					duration: '1000'
				});
			});

			/* =================== RETURN TODAY'S DATE =================== */
			// return today's date as MM/DD/YYYY
			var d = new Date(); // creates a date object
			var month = d.getMonth()+1; // gets the month
			var day = d.getDate(); // gets the day
			
			// concats them together
			var newOutput =  ((''+month).length<2 ? '0' : '') + month + '/' +
			((''+day).length<2 ? '0' : '') + day  + '/' +
			d.getFullYear();

			// returns the variable. If the output is not working would show 'today's date here'
			$("#todays-date").html(newOutput);

			// returns today's date as YYYY-MM-DD
			var maxDate = d.getFullYear() + '-' 
			+ ((''+month).length<2 ? '0' : '') + month + '-' +
			((''+day).length<2 ? '0' : '') + day;
			
			// restricts due date input to only selecting dates after today's date
			$('#end_date').attr('min', maxDate);
			
			/* =================== SHOW NUMBER OF DAYS LEFT BEFORE DUE DATE =================== */
			$("#end_date").change(
				function (e) { 
					e.preventDefault();
					var due_date = $("#end_date").val();

					var input_date = new Date(due_date);

					// calcuate the difference in number of days between

					// To calculate the time difference of two dates
					var Difference_In_Time = input_date.getTime() - d.getTime();
					
					// To calculate the no. of days between two dates
					var Difference_In_Days = Difference_In_Time / (1000 * 3600 * 24);

					// round up then +1
					var result = Math.ceil(Difference_In_Days) + 1;
					
					$("#total-days").html(result);
				}
			);
		});
	</script>
</body>
</html>
